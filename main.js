!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t===a-1?"top-right":t>0&&t<a-1?"top":t===a**2-1?"bottom-right":t===a*(a-1)?"bottom-left":t%a==0?"left":(t+1)%a==0?"right":t>a*(a-1)&&t<a**2-1?"bottom":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const r=document.createElement("div");r.classList.add("health-level");const i=document.createElement("div");i.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),i.style.width=`${a.character.health}%`,r.appendChild(i),s.appendChild(r),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),s.appendChild(r),r.addEventListener("animationend",(()=>{s.removeChild(r),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var t="prairie",a="desert",s="arctic",r="mountain";class i{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw"Нет смысла создавать нового Character()"}levelUp(){if(this.level>1)for(let e=1;e<this.level;e++)this.attack=Math.max(this.attack,this.attack*(80+this.health)/100),this.defence=Math.max(this.defence,this.defence*(80+this.health)/100)}}class l{constructor(e,t){if(!(e instanceof i))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class c{static playerPosition(e){let t=[],a=0,s=1;for(let r=0;r<e-1;r++)t.push(a),t.push(s),a+=e,s+=e;return t}static enemyPosition(e){let t=[],a=e-2,s=e-1;for(let r=0;r<e-1;r++)t.push(a),t.push(s),a+=e,s+=e;return t}static createLine(e,t){let a=[];for(let s=0;s<t;s++)a.push(e),e++;return a}static createBoard(e){let t=[],a=0;for(let s=0;s<e;s++)t.push(c.createLine(a,e)),a+=e;return t}static getLocation(e,t){let a,s,r=[];return t.forEach(((t,r)=>{-1!==t.indexOf(e)&&(s=t.indexOf(e),a=r)})),r.push(a),r.push(s),r}static neighboringPositions(e,t,a){let s=c.createBoard(t),r=c.getLocation(e,s),i=r[0],l=r[1],n=[],o=[i];for(let e=1;e<=a;e++){let a=i+e;a>-1&&a<t&&o.push(a);let s=i-e;s>-1&&s<t&&o.push(s)}let h=[l];for(let e=1;e<=a;e++){let a=l+e;a>-1&&a<t&&h.push(a);let s=l-e;s>-1&&s<t&&h.push(s)}o=o.sort(((e,t)=>e-t)),h=h.sort(((e,t)=>e-t));for(let e=0;e<o.length;e++)for(let t=0;t<h.length;t++)n.push(s[o[e]][h[t]]);return n}static getAverage(e){let t=0,a=0;for(let s=0;s<e.length;s++)t+=e[s][0],a+=e[s][1];return[Math.floor(t/e.length),Math.floor(a/e.length)]}static findClosest(e,t){let a=[];return e.forEach((e=>{let s=Math.abs(e[0]-t[0]),r=Math.abs(e[1]-t[1]);a.push(Math.sqrt(s^2+r^2))})),a.indexOf(a.reduce(((e,t)=>Math.min(e,t))))}static generateRandom(e){return Math.floor(Math.random()*e.length)}}class n{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}class o{static from(e){return new n(localStorage).save(e),null}}class h{constructor(e){this.characters=e}}class d extends i{constructor(e){super(e),this.attack=25,this.defence=25,this.type="bowman"}}class m extends i{constructor(e){super(e),this.attack=40,this.defence=10,this.type="swordsman"}}class u extends i{constructor(e){super(e),this.attack=40,this.defence=10,this.type="undead"}}class g extends i{constructor(e){super(e),this.attack=10,this.defence=40,this.type="magician"}}class y extends i{constructor(e){super(e),this.attack=10,this.defence=10,this.type="daemon"}}class p extends i{constructor(e){super(e),this.attack=25,this.defence=25,this.type="vampire"}}function*v(e,t){for(;e&&t;){let a=1+Math.floor(Math.random()*t);const s=new Map([["Bowman",new d(a)],["Daemon",new y(a)],["Magician",new g(a)],["Swordsman",new m(a)],["Undead",new u(a)],["Vampire",new p(a)]]);let r=Math.floor(Math.random()*e.length),i=s.get(e[r]);i.level>1&&i.levelUp(),yield i}}function f(e,t,a){let s=[];for(let r=1;r<=a;r++){const a=v(e,t).next().value;s.push(a)}return new h(s)}class P{constructor(){this.name="GameRule"}static generatePlayerTeam(){return f(["Bowman","Swordsman","Magician"],3,2)}static generateEnemyTeam(){return f(["Vampire","Undead","Daemon"],3,2)}static setActiveEnemy(e,t){let a=c.createBoard(t),s=["vampire","undead","daemon"],r=e.filter((e=>!s.includes(e.character.type))),i=e.filter((e=>s.includes(e.character.type))),l=r.map((e=>c.getLocation(e.position,a))),n=i.map((e=>c.getLocation(e.position,a))),o=i[c.findClosest(n,c.getAverage(l))];return localStorage.setItem("activeEnemy",o.position),o}static chooseEnemy(e){return e.filter((e=>e.position===Number(localStorage.activeEnemy)))}static movementRadius(e,t){let a=new Map([["swordsman",4],["undead",4],["bowman",2],["vampire",2],["magician",1],["daemon",1]]);return c.neighboringPositions(e.position,t,a.get(e.character.type))}static attackRadius(e,t){let a=new Map([["swordsman",1],["undead",1],["bowman",2],["vampire",2],["magician",4],["daemon",4]]);return c.neighboringPositions(e.position,t,a.get(e.character.type))}static checkEnemyMoves(e,t,a){let s=P.movementRadius(e,t),r=a.map((e=>e.position)),i=[];s.forEach((e=>{r.includes(e)||i.push(c.getLocation(e,c.createBoard(t)))}));let l=c.getLocation(Number(localStorage.activePlayer),c.createBoard(t));return s[c.findClosest(i,l)]}static checkEnemyAttack(e,t,a){let s=P.attackRadius(e,a),r=[];return t.forEach((e=>{s.includes(e.position)&&r.push(e.position)})),r}static calculateDamage(e,t){let a=Math.floor(Math.max(e.character.attack-t.character.defence,.1*e.character.attack));return t.character.health-=a,a}static getPlayerCharacters(e){let t=["bowman","swordsman","magician"];return e.filter((e=>t.includes(e.character.type)))}static getEnemyCharacters(e){let t=["vampire","undead","daemon"];return e.filter((e=>t.includes(e.character.type)))}static getCharacterByIndex(e,t){return t.filter((t=>t.position===e))[0]}}const C=new e;C.bindToDOM(document.querySelector("#game-container"));const w=new n(localStorage),E=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.characters=[],this.level=1,this.status=1}init(){localStorage.removeItem("activePlayer"),localStorage.removeItem("activeEnemy"),this.status=1;let e=[];this.gamePlay.addNewGameListener((()=>this.onNewGameClick())),this.gamePlay.addSaveGameListener((()=>this.onSaveGameClick())),this.gamePlay.addLoadGameListener((()=>this.onLoadGameClick())),1===this.level?(this.gamePlay.drawUi(t),this.playerTeam=P.generatePlayerTeam(),this.enemyTeam=P.generateEnemyTeam(),this.playerTeam.characters.forEach((t=>{this.renderTeam(c.playerPosition(this.gamePlay.boardSize),t,e)}))):this.enemyTeam=P.generateEnemyTeam(),localStorage.setItem("nextPlayer",0),localStorage.activePlayer&&delete localStorage.activePlayer,this.enemyTeam.characters.forEach((t=>{this.renderTeam(c.enemyPosition(this.gamePlay.boardSize),t,e)})),this.gamePlay.redrawPositions(this.characters),this.gamePlay.addCellEnterListener((e=>{this.onCellEnter(e)&&this.showTip(e)})),this.gamePlay.addCellLeaveListener((e=>{this.onCellLeave(e)&&this.gamePlay.hideCellTooltip(e)})),this.gamePlay.addCellClickListener((e=>this.onCellClick(e)))}onCellClick(t){if(1===this.status&&"0"===localStorage.nextPlayer){let a=["bowman","swordsman","magician"],s=this.characters;if(localStorage.activePlayer){let e=P.getCharacterByIndex(Number(localStorage.activePlayer),s);if(this.characters.map((e=>e.position)).includes(t)){let r=P.getCharacterByIndex(t,s);if(a.includes(r.character.type))this.setActivePlayer(t);else if(P.attackRadius(e,this.gamePlay.boardSize).includes(t)){let a=P.getCharacterByIndex(t,s);this.makeDamage(e,a),this.setNextPlayer()}}else P.movementRadius(e,this.gamePlay.boardSize).includes(t)&&(e.position=t,this.setActivePlayer(t),this.gamePlay.redrawPositions(this.characters),this.setNextPlayer())}else this.characters.forEach((s=>{s.position===t&&(a.includes(s.character.type)?this.setActivePlayer(t):e.showError("Это не персонаж игрока"))}))}}onCellEnter(e){let t=this.characters.map((e=>e.position));if(1===this.status)return this.showOptions(e),!!t.includes(e)}showOptions(e){if("0"===localStorage.nextPlayer&&localStorage.activePlayer){let t=P.getCharacterByIndex(Number(localStorage.activePlayer),this.characters);t&&(this.characters.map((e=>e.position)).includes(e)?P.getEnemyCharacters(this.characters).map((e=>e.position)).includes(e)?P.attackRadius(t,this.gamePlay.boardSize).includes(e)?(this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor("not-allowed"):this.gamePlay.setCursor("pointer"):P.movementRadius(t,this.gamePlay.boardSize).includes(e)?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor("not-allowed"))}}onCellLeave(e){if(1===this.status){let t=this.characters.map((e=>e.position));return Number(localStorage.activePlayer)!==e&&this.gamePlay.deselectCell(e),!!t.includes(e)}}generateTip(e,t,a,s){return`🎖${e} ⚔${t} 🛡${a} ❤${s}`}showTip(e){this.characters.forEach((t=>{if(t.position===e){let a=this.generateTip(t.character.level,t.character.attack,t.character.defence,t.character.health);this.gamePlay.showCellTooltip(a,e)}}))}renderTeam(e,t,a){let s=c.generateRandom(e);a.includes(e[s])&&(s=c.generateRandom(e)),a.push(e[s]),this.characters.push(new l(t,e[s]))}setActivePlayer(e){localStorage.activePlayer&&this.gamePlay.deselectCell(localStorage.activePlayer),this.gamePlay.selectCell(e),localStorage.setItem("activePlayer",e)}setNextPlayer(){1===this.status&&(this.healthListener(),localStorage.nextPlayer&&("0"===localStorage.nextPlayer?(localStorage.setItem("nextPlayer",1),setTimeout((()=>this.runEnemyTurn()),500)):localStorage.setItem("nextPlayer",0)))}runEnemyTurn(){let e=P.setActiveEnemy(this.characters,this.gamePlay.boardSize);this.moveOrAttack(e),this.setNextPlayer()}moveOrAttack(){let e=P.getCharacterByIndex(Number(localStorage.activeEnemy),this.characters),t=P.checkEnemyAttack(e,P.getPlayerCharacters(this.characters),this.gamePlay.boardSize),a=P.getCharacterByIndex(t[0],this.characters);t.length?(1!==t.length&&(a=this.characters.filter((e=>t.includes(e.position))),a=a.sort(((e,t)=>e.character.health-t.character.health))[0]),this.makeDamage(e,a)):(e.position=P.checkEnemyMoves(e,this.gamePlay.boardSize,this.characters),this.gamePlay.redrawPositions(this.characters))}makeDamage(e,t){let a=this.characters,s=P.calculateDamage(e,t);this.gamePlay.showDamage(t.position,s).then((()=>this.gamePlay.redrawPositions(a))),this.healthListener()}levelUp(){if(4===this.level)return void this.gameOver();this.level+=1;let e=new Map([[1,t],[2,a],[3,s],[4,r]]);this.init(),this.gamePlay.drawUi(e.get(this.level)),P.getPlayerCharacters(this.characters).forEach((e=>{e.character.level+=1,e.character.levelUp(),e.character.health+=80,e.character.health>100&&(e.character.health=100)})),this.gamePlay.redrawPositions(this.characters)}healthListener(){let e=[];for(let t=0;t<this.characters.length;t++)this.characters[t].character.health<=0&&e.push(t);if(e.length){if(this.characters[e[0]].position===Number(localStorage.activePlayer)?(this.gamePlay.setCursor("default"),localStorage.removeItem("activePlayer")):this.characters[e[0]].position===Number(localStorage.activeEnemy)&&localStorage.removeItem("activeEnemy"),this.gamePlay.deselectCell(this.characters[e[0]].position),this.characters.splice(e[0],1),this.gamePlay.redrawPositions(this.characters),!P.getPlayerCharacters(this.characters).length)return void this.gameOver();P.getEnemyCharacters(this.characters).length||this.levelUp()}}gameOver(){this.gamePlay.setCursor("default"),this.status=0,this.characters.forEach((e=>{this.gamePlay.deselectCell(e.position)})),this.gamePlay.addNewGameListener((()=>{this.level=1,this.init()}))}onNewGameClick(){this.level=1,this.characters=[],this.init()}onSaveGameClick(){o.from(this)}onLoadGameClick(){if(localStorage.state){this.characters.forEach((e=>{this.gamePlay.deselectCell(e.position)})),this.gamePlay.setCursor("default");let e=new n(localStorage).load();this.characters=e.characters,this.level=e.level,this.status=e.status,this.gamePlay.redrawPositions(this.characters)}}}(C,w);E.init()}();